name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_IP_HOST}}
          username: ${{ secrets.VPS_USERNAME}}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            # Di chuyển vào thư mục dự án
            cd server-shopsifu

            # Kéo code mới nhất
            git fetch origin master
            git reset --hard origin/master

            # Xóa cache và build cũ
            rm -rf dist
            rm -rf node_modules/.cache

            # Cài đặt dependencies
            npm ci

            # Build và restart
            npm run build
            pm2 restart server-shopsifu || pm2 start dist/main.js --name server-shopsifu

            # Kiểm tra status
            pm2 status
            pm2 logs server-shopsifu --lines 20

      - name: Get deployment details
        id: deployment
        run: |
          echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "commit_date=$(git log -1 --pretty=%cd)" >> $GITHUB_OUTPUT
          echo "branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        if: always()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            {
              "embeds": [
                {
                  "title": "🚀 Deployment Status: ${{ job.status }}",
                  "color": ${{ job.status == 'success' && '65280' || '16711680' }},
                  "description": "**Commit Message:**\n${{ steps.deployment.outputs.commit_message }}\n\n**Environment:** Production",
                  "fields": [
                    {
                      "name": "📦 Repository",
                      "value": "[${{ github.repository }}](https://github.com/${{ github.repository }})",
                      "inline": true
                    },
                    {
                      "name": "🌿 Branch",
                      "value": "`${{ steps.deployment.outputs.branch }}`",
                      "inline": true
                    },
                    {
                      "name": "👤 Author",
                      "value": "${{ steps.deployment.outputs.commit_author }}",
                      "inline": true
                    },
                    {
                      "name": "🔗 Commit",
                      "value": "[`${{ steps.deployment.outputs.commit_sha }}`](https://github.com/${{ github.repository }}/commit/${{ steps.deployment.outputs.commit_sha }})",
                      "inline": true
                    },
                    {
                      "name": "⏰ Deployed At",
                      "value": "<t:${{ toJSON(github.event.head_commit.timestamp) }}:F>",
                      "inline": true
                    },
                    {
                      "name": "🔄 Status",
                      "value": "${{ job.status == 'success' && '✅ Success' || '❌ Failed' }}",
                      "inline": true
                    }
                  ],
                  "footer": {
                    "text": "Shopsifu Backend Deployment"
                  },
                  "timestamp": "${{ toJSON(github.event.head_commit.timestamp) }}"
                }
              ]
            }
