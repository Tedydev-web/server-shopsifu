name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_IP_HOST}}
          username: ${{ secrets.VPS_USERNAME}}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            # Di chuyá»ƒn vÃ o thÆ° má»¥c dá»± Ã¡n
            cd server-shopsifu

            # KÃ©o code má»›i nháº¥t
            git fetch origin master
            git reset --hard origin/master

            # XÃ³a cache vÃ  build cÅ©
            rm -rf dist
            rm -rf node_modules/.cache

            # CÃ i Ä‘áº·t dependencies
            npm ci

            # Build vÃ  restart
            npm run build
            pm2 restart server-shopsifu || pm2 start dist/main.js --name server-shopsifu

            # Kiá»ƒm tra status
            pm2 status
            pm2 logs server-shopsifu --lines 20

      - name: Get deployment details
        id: deployment
        run: |
          echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "commit_date=$(git log -1 --pretty=%cd)" >> $GITHUB_OUTPUT
          echo "branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        if: always()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            {
              "embeds": [
                {
                  "title": "ğŸš€ Deployment Status: ${{ job.status }}",
                  "color": ${{ job.status == 'success' && '65280' || '16711680' }},
                  "description": "**Commit Message:**\n${{ steps.deployment.outputs.commit_message }}\n\n**Environment:** Production",
                  "fields": [
                    {
                      "name": "ğŸ“¦ Repository",
                      "value": "[${{ github.repository }}](https://github.com/${{ github.repository }})",
                      "inline": true
                    },
                    {
                      "name": "ğŸŒ¿ Branch",
                      "value": "`${{ steps.deployment.outputs.branch }}`",
                      "inline": true
                    },
                    {
                      "name": "ğŸ‘¤ Author",
                      "value": "${{ steps.deployment.outputs.commit_author }}",
                      "inline": true
                    },
                    {
                      "name": "ğŸ”— Commit",
                      "value": "[`${{ steps.deployment.outputs.commit_sha }}`](https://github.com/${{ github.repository }}/commit/${{ steps.deployment.outputs.commit_sha }})",
                      "inline": true
                    },
                    {
                      "name": "â° Deployed At",
                      "value": "<t:${{ toJSON(github.event.head_commit.timestamp) }}:F>",
                      "inline": true
                    },
                    {
                      "name": "ğŸ”„ Status",
                      "value": "${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }}",
                      "inline": true
                    }
                  ],
                  "footer": {
                    "text": "Shopsifu Backend Deployment"
                  },
                  "timestamp": "${{ toJSON(github.event.head_commit.timestamp) }}"
                }
              ]
            }
