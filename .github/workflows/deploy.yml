name: CI/CD Pipeline

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      manual_rollback:
        description: 'Commit SHA ho·∫∑c tag ƒë·ªÉ rollback (ƒë·ªÉ tr·ªëng ƒë·ªÉ deploy b√¨nh th∆∞·ªùng)'
        required: false

jobs:
  # 1. Build & Test
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Cache node_modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      # - name: Run tests
      #   run: npm test

  # 2. Deploy to Production
  deploy:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && !github.event.inputs.manual_rollback) }}
    env:
      NODE_ENV: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate .env
        run: |
          cat <<EOF > .env
          PORT=3000
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          ACCESS_TOKEN_EXPIRES_IN=${{ secrets.ACCESS_TOKEN_EXPIRES_IN }}
          REFRESH_TOKEN_EXPIRES_IN=${{ secrets.REFRESH_TOKEN_EXPIRES_IN }}
          ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}
          REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
          SECRET_API_KEY=${{ secrets.SECRET_API_KEY }}
          ADMIN_NAME="${{ secrets.ADMIN_NAME }}"
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
          ADMIN_PHONE_NUMBER=${{ secrets.ADMIN_PHONE_NUMBER }}
          OTP_EXPIRES_IN=${{ secrets.OTP_EXPIRES_IN }}
          RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }}
          GOOGLE_CLIENT_REDIRECT_URI=${{ secrets.GOOGLE_CLIENT_REDIRECT_URI }}
          EOF

      - name: Deploy via SSH & PM2
        id: ssh_deploy
        run: |
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_IP_HOST }} << 'EOF'
            set -euo pipefail
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            source ~/.bashrc; source ~/.profile
            cd ${{ secrets.PATH_PROJECT }}
            git fetch origin master && git reset --hard origin/master
            rm -rf dist node_modules
            npm ci && npm run build
            pm2 describe server-shopsifu &>/dev/null && pm2 restart server-shopsifu || pm2 start dist/main.js --name server-shopsifu
            pm2 status server-shopsifu > /tmp/pm2_status.txt
            pm2 logs server-shopsifu --lines 100 --nostream > /tmp/pm2_logs.txt
            STATUS=$(pm2 info server-shopsifu | grep status | awk '{print $4}')
            echo "$STATUS" > /tmp/app_status.txt
            if [[ "$STATUS" != "online" ]]; then
              exit 2
            fi
          EOF
        continue-on-error: true

      - name: Collect PM2 Output
        if: always()
        id: pm2_logs
        run: |
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_IP_HOST }} << 'EOF'
            echo "::set-output name=status::$(cat /tmp/pm2_status.txt)"
            echo "::set-output name=logs::$(cat /tmp/pm2_logs.txt)"
          EOF

      - name: Tag Release
        if: success()
        run: |
          TAG=v$(date +'%Y.%m.%d.%H%M%S')
          git tag $TAG
          git push origin $TAG

      - name: Send Discord Notification
        uses: Ilshidur/action-discord@master
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            **üöÄ Deployment Notification**
            **Status**: ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}
            **Ref**: `${{ github.ref }}`
            **Commit**: `${{ github.sha }}`
            **Actor**: `${{ github.actor }}`
            **PM2 Status:**
            ```
            ${{ steps.pm2_logs.outputs.status }}
            ```
            **Last 100 lines of Logs:**
            ```
            ${{ steps.pm2_logs.outputs.logs }}
            ```

  # 3. Automatic Rollback on Failure
  rollback-auto:
    name: Automatic Rollback
    needs: deploy
    runs-on: ubuntu-latest
    if: needs.deploy.result == 'failure'
    steps:
      - name: Rollback to previous commit on server
        run: |
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_IP_HOST }} << 'EOF'
            set -euo pipefail
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            source ~/.bashrc; source ~/.profile
            cd ${{ secrets.PATH_PROJECT }}
            git fetch origin master
            git reset --hard HEAD~1
            rm -rf dist node_modules
            npm ci && npm run build
            pm2 restart server-shopsifu
          EOF

  # 4. Manual Rollback
  manual-rollback:
    name: Manual Rollback
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.manual_rollback
    runs-on: ubuntu-latest
    steps:
      - name: Checkout specific commit/tag
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.manual_rollback }}

      - name: Re-deploy to VPS
        run: |
          # Copy l·∫°i c√°c b∆∞·ªõc deploy SSH nh∆∞ tr√™n, nh∆∞ng v·ªõi ref c·ª• th·ªÉ ƒë√£ checkout
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_IP_HOST }} << 'EOF'
            set -euo pipefail
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            source ~/.bashrc; source ~/.profile
            cd ${{ secrets.PATH_PROJECT }}
            git reset --hard HEAD
            rm -rf dist node_modules
            npm ci && npm run build
            pm2 restart server-shopsifu
          EOF

permissions:
  contents: write
