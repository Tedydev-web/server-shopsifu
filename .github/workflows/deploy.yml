name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_IP_HOST}}
          username: ${{ secrets.VPS_USERNAME}}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            bash -i << 'EOF'
            # Load shell environment
            source ~/.bashrc
            source ~/.profile

            # Ki·ªÉm tra m√¥i tr∆∞·ªùng
            whoami
            pwd
            echo $PATH
            which npm
            which pm2
            node --version || echo "Node.js not found"
            npm --version || echo "npm not found"
            pm2 --version || echo "pm2 not found"
            
            # Di chuy·ªÉn v√†o th∆∞ m·ª•c d·ª± √°n
            cd server-shopsifu
            
            # T·∫°o file .env t·ª´ secret
            echo "${{ secrets.ENV }}" > .env
            
            # Ki·ªÉm tra file .env ƒë√£ ƒë∆∞·ª£c t·∫°o
            ls -la .env
            echo "File .env ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng"
            
            # K√©o code m·ªõi nh·∫•t
            git pull
            
            # X√≥a cache v√† build c≈©
            rm -rf dist
            rm -rf node_modules/.cache
            rm -rf node_modules
            
            # C√†i ƒë·∫∑t dependencies
            npm ci
            
            # Build v√† restart
            npm run build
            pm2 restart server-shopsifu
            
            # Ki·ªÉm tra status
            pm2 status
            pm2 logs server-shopsifu --lines 20

      - name: Get deployment details
        id: deployment
        run: |
          echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "commit_date=$(git log -1 --pretty=%cd)" >> $GITHUB_OUTPUT
          echo "branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        if: always()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            ```json
            {
              "embeds": [
                {
                  "title": "üöÄ Deployment Status: ${{ job.status }}",
                  "color": ${{ job.status == 'success' && '65280' || '16711680' }},
                  "description": "**Commit Message:**\n${{ steps.deployment.outputs.commit_message }}\n\n**Environment:** Production",
                  "fields": [
                    {
                      "name": "üì¶ Repository",
                      "value": "[${{ github.repository }}](https://github.com/${{ github.repository }})",
                      "inline": true
                    },
                    {
                      "name": "üåø Branch",
                      "value": "`${{ steps.deployment.outputs.branch }}`",
                      "inline": true
                    },
                    {
                      "name": "üë§ Author",
                      "value": "${{ steps.deployment.outputs.commit_author }}",
                      "inline": true
                    },
                    {
                      "name": "üîó Commit",
                      "value": "[`${{ steps.deployment.outputs.commit_sha }}`](https://github.com/${{ github.repository }}/commit/${{ steps.deployment.outputs.commit_sha }})",
                      "inline": true
                    },
                    {
                      "name": "‚è∞ Deployed At",
                      "value": "<t:${{ toJSON(github.event.head_commit.timestamp) }}:F>",
                      "inline": true
                    },
                    {
                      "name": "üîÑ Status",
                      "value": "${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}",
                      "inline": true
                    }
                  ],
                  "footer": {
                    "text": "Shopsifu Backend Deployment"
                  },
                  "timestamp": "${{ toJSON(github.event.head_commit.timestamp) }}"
                }
              ]
            }