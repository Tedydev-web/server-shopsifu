name: ğŸ“Š System Status Check

on:
  schedule:
    - cron: '0 */6 * * *' # Cháº¡y má»—i 6 giá»
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Loáº¡i kiá»ƒm tra'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - services
          - database
          - monitoring

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
  VPS_PATH: ${{ secrets.VPS_PATH }}

jobs:
  status-check:
    name: ğŸ“Š Check System Status
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Check Docker Compose Status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail
            cd "${{ env.VPS_PATH }}"

            echo "ğŸ” Checking Docker Compose status..."

            # Check if docker-compose.yml exists
            if [ -f "docker-compose.yml" ]; then
              echo "âœ… docker-compose.yml found"
            else
              echo "âŒ docker-compose.yml not found"
              exit 1
            fi

            # Check service status
            echo "ğŸ¥ Checking service status..."
            docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"

            # Check if all services are running
            RUNNING_SERVICES=$(docker compose ps --filter "status=running" --format "{{.Name}}" | wc -l)
            TOTAL_SERVICES=$(docker compose ps --format "{{.Name}}" | wc -l)
            echo "ğŸ“Š Services: $RUNNING_SERVICES/$TOTAL_SERVICES running"

      - name: ğŸ—„ï¸ Check Database Status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "ğŸ—„ï¸ Checking database status..."

            # Check PostgreSQL
            if pg_isready -h localhost -p 5432 -U shopsifu; then
              echo "âœ… PostgreSQL is ready"
            else
              echo "âŒ PostgreSQL is not ready"
            fi

            # Check Redis
            if redis-cli -a "Shopsifu2025" ping | grep -q "PONG"; then
              echo "âœ… Redis is ready"
            else
              echo "âŒ Redis is not ready"
            fi

            # Check Elasticsearch
            if curl -fsS http://localhost:9200 > /dev/null; then
              echo "âœ… Elasticsearch is ready"
            else
              echo "âŒ Elasticsearch is not ready"
            fi

      - name: ğŸ“Š Check Monitoring Status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "ğŸ“Š Checking monitoring status..."

            # Check Prometheus
            if curl -fsS http://localhost:9090/-/healthy > /dev/null; then
              echo "âœ… Prometheus is healthy"
            else
              echo "âŒ Prometheus is not healthy"
            fi

            # Check Grafana
            if curl -fsS http://localhost:3001/api/health > /dev/null; then
              echo "âœ… Grafana is healthy"
            else
              echo "âŒ Grafana is not healthy"
            fi

            # Check Kibana
            if curl -fsS http://localhost:5601/api/status > /dev/null; then
              echo "âœ… Kibana is healthy"
            else
              echo "âŒ Kibana is not healthy"
            fi

      - name: ğŸš€ Check Application Status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "ğŸš€ Checking application status..."

            # Check server health
            if curl -fsS http://localhost:3000/health > /dev/null; then
              echo "âœ… Application server is healthy"
            else
              echo "âŒ Application server is not healthy"
            fi

            # Check server metrics
            echo "ğŸ“ˆ Server metrics:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}"

      - name: ğŸ“Š Check System Resources
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "ğŸ“Š Checking system resources..."

            # Check disk usage
            echo "ğŸ’¾ Disk usage:"
            df -h /

            # Check memory usage
            echo "ğŸ§  Memory usage:"
            free -h

            # Check CPU load
            echo "âš¡ CPU load:"
            uptime

            # Check Docker disk usage
            echo "ğŸ³ Docker disk usage:"
            docker system df

  notification:
    name: ğŸ“¢ Status Notification
    needs: status-check
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: always()
    steps:
      - name: ğŸ“¢ Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ needs.status-check.outcome == 'success' && 'success' || 'failure' }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          COLOR=$([ "$STATUS" = "success" ] && echo 3066993 || echo 15158332)
          ICON=$([ "$STATUS" = "success" ] && echo "âœ…" || echo "âŒ")
          DESCRIPTION=$([ "$STATUS" = "success" ] && echo "ğŸ“Š **System Status: Healthy**" || echo "âŒ **System Status: Issues Detected**")

          JSON_PAYLOAD=$(jq -n \
            --arg status "$STATUS" \
            --arg icon "$ICON" \
            --arg description "$DESCRIPTION" \
            --arg color "$COLOR" \
            ' {
                embeds: [{
                  title: "ğŸ“Š SYSTEM STATUS CHECK",
                  description: $description,
                  color: ($color | tonumber),
                  fields: [
                    { name: "ğŸ“Š Tráº¡ng thÃ¡i", value: "\($icon) \($status | ascii_upcase)", inline: true },
                    { name: "â° Thá»i gian", value: "\(now | strftime("%Y-%m-%d %H:%M:%S UTC"))", inline: true }
                  ],
                  footer: { "text": "ğŸ“Š System Status Check" },
                  timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
                }]
              }')

          curl -s -H "Content-Type: application/json" -X POST -d "$JSON_PAYLOAD" "$DISCORD_WEBHOOK" || echo "Lá»—i gá»­i thÃ´ng bÃ¡o Discord"
