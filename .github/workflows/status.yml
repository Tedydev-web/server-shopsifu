name: 📊 System Status Check

on:
  schedule:
    - cron: '0 */6 * * *' # Chạy mỗi 6 giờ
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Loại kiểm tra'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - services
          - database
          - monitoring

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
  VPS_PATH: ${{ secrets.VPS_PATH }}

jobs:
  status-check:
    name: 📊 Check System Status
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🔌 Test SSH Connection
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          timeout: 30s
          command_timeout: 60s
          script: |
            echo "🔌 Testing SSH connection..."
            echo "✅ SSH connection successful"
            echo "📍 Current directory: $(pwd)"
            echo "👤 User: $(whoami)"
            echo "🖥️  Hostname: $(hostname)"

      - name: 🔍 Run Comprehensive Health Check
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          timeout: 120s
          command_timeout: 300s
          script: |
            set -euo pipefail

            echo "🔍 Running comprehensive health check..."

                        # Install required tools if not present
            sudo apt-get update -qq
            sudo apt-get install -y -qq jq netcat-openbsd postgresql-client redis-tools

            # Set environment variables with fallback
            VPS_PATH="${VPS_PATH:-shopsifu/server-shopsifu}"
            export VPS_PATH="$VPS_PATH"
            export DISCORD_WEBHOOK="${{ secrets.DISCORD_WEBHOOK }}"

            echo "🔍 Debug: VPS_PATH set to: $VPS_PATH"

            # Run comprehensive health check script
            if [ -f "$VPS_PATH/scripts/comprehensive-health-check.sh" ]; then
              chmod +x "$VPS_PATH/scripts/comprehensive-health-check.sh"
              "$VPS_PATH/scripts/comprehensive-health-check.sh"
            else
              echo "❌ Comprehensive health check script not found"
              echo "📊 Running basic status check..."

              cd "$VPS_PATH"
              docker compose -f "$VPS_PATH/docker-compose.yml" ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"

              RUNNING_SERVICES=$(docker compose -f "$VPS_PATH/docker-compose.yml" ps --filter "status=running" --format "{{.Name}}" | wc -l)
              TOTAL_SERVICES=$(docker compose -f "$VPS_PATH/docker-compose.yml" ps --format "{{.Name}}" | wc -l)
              echo "📊 Services: $RUNNING_SERVICES/$TOTAL_SERVICES running"
            fi

      - name: 🚀 Check Application Status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "🚀 Checking application status..."

            # Check server health
            if curl -fsS http://localhost:3000/health > /dev/null; then
              echo "✅ Application server is healthy"
            else
              echo "❌ Application server is not healthy"
            fi

            # Check server metrics
            echo "📈 Server metrics:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}"

      - name: 📊 Check System Resources
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "📊 Checking system resources..."

            # Check disk usage
            echo "💾 Disk usage:"
            df -h /

            # Check memory usage
            echo "🧠 Memory usage:"
            free -h

            # Check CPU load
            echo "⚡ CPU load:"
            uptime

            # Check Docker disk usage
            echo "🐳 Docker disk usage:"
            docker system df

  notification:
    name: 📢 Status Notification
    needs: status-check
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: always()
    steps:
      - name: 📢 Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ needs.status-check.outcome == 'success' && 'success' || 'failure' }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          COLOR=$([ "$STATUS" = "success" ] && echo 3066993 || echo 15158332)
          ICON=$([ "$STATUS" = "success" ] && echo "✅" || echo "❌")
          DESCRIPTION=$([ "$STATUS" = "success" ] && echo "📊 **System Status: Healthy**" || echo "❌ **System Status: Issues Detected**")

          JSON_PAYLOAD=$(jq -n \
            --arg status "$STATUS" \
            --arg icon "$ICON" \
            --arg description "$DESCRIPTION" \
            --arg color "$COLOR" \
            ' {
                embeds: [{
                  title: "📊 SYSTEM STATUS CHECK",
                  description: $description,
                  color: ($color | tonumber),
                  fields: [
                    { name: "📊 Trạng thái", value: "\($icon) \($status | ascii_upcase)", inline: true },
                    { name: "⏰ Thời gian", value: "\(now | strftime("%Y-%m-%d %H:%M:%S UTC"))", inline: true }
                  ],
                  footer: { "text": "📊 System Status Check" },
                  timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
                }]
              }')

          curl -s -H "Content-Type: application/json" -X POST -d "$JSON_PAYLOAD" "$DISCORD_WEBHOOK" || echo "Lỗi gửi thông báo Discord"
