name: ğŸ“Š System Status Check

on:
  schedule:
    - cron: '0 */6 * * *' # Cháº¡y má»—i 6 giá»
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Loáº¡i kiá»ƒm tra'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - services
          - database
          - monitoring

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
  VPS_PATH: ${{ secrets.VPS_PATH }}

jobs:
  status-check:
    name: ğŸ“Š Check System Status
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”Œ Test SSH Connection
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          timeout: 30s
          command_timeout: 60s
          script: |
            echo "ğŸ”Œ Testing SSH connection..."
            echo "âœ… SSH connection successful"
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ‘¤ User: $(whoami)"
            echo "ğŸ–¥ï¸  Hostname: $(hostname)"

      - name: ğŸ” Run Comprehensive Health Check
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          timeout: 120s
          command_timeout: 300s
          script: |
            set -euo pipefail

            echo "ğŸ” Running comprehensive health check..."

                        # Install required tools if not present
            sudo apt-get update -qq
            sudo apt-get install -y -qq jq netcat-openbsd postgresql-client redis-tools

            # Set environment variables with fallback
            VPS_PATH="${VPS_PATH:-shopsifu/server-shopsifu}"
            export VPS_PATH="$VPS_PATH"
            export DISCORD_WEBHOOK="${{ secrets.DISCORD_WEBHOOK }}"

            echo "ğŸ” Debug: VPS_PATH set to: $VPS_PATH"

            # Run comprehensive health check script
            if [ -f "$VPS_PATH/scripts/comprehensive-health-check.sh" ]; then
              chmod +x "$VPS_PATH/scripts/comprehensive-health-check.sh"
              "$VPS_PATH/scripts/comprehensive-health-check.sh"
            else
              echo "âŒ Comprehensive health check script not found"
              echo "ğŸ“Š Running basic status check..."

              cd "$VPS_PATH"
              docker compose -f "$VPS_PATH/docker-compose.yml" ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"

              RUNNING_SERVICES=$(docker compose -f "$VPS_PATH/docker-compose.yml" ps --filter "status=running" --format "{{.Name}}" | wc -l)
              TOTAL_SERVICES=$(docker compose -f "$VPS_PATH/docker-compose.yml" ps --format "{{.Name}}" | wc -l)
              echo "ğŸ“Š Services: $RUNNING_SERVICES/$TOTAL_SERVICES running"
            fi

      - name: ğŸš€ Check Application Status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "ğŸš€ Checking application status..."

            # Check server health
            if curl -fsS http://localhost:3000/health > /dev/null; then
              echo "âœ… Application server is healthy"
            else
              echo "âŒ Application server is not healthy"
            fi

            # Check server metrics
            echo "ğŸ“ˆ Server metrics:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}"

      - name: ğŸ“Š Check System Resources
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "ğŸ“Š Checking system resources..."

            # Check disk usage
            echo "ğŸ’¾ Disk usage:"
            df -h /

            # Check memory usage
            echo "ğŸ§  Memory usage:"
            free -h

            # Check CPU load
            echo "âš¡ CPU load:"
            uptime

            # Check Docker disk usage
            echo "ğŸ³ Docker disk usage:"
            docker system df

  notification:
    name: ğŸ“¢ Status Notification
    needs: status-check
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: always()
    steps:
      - name: ğŸ“¢ Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ needs.status-check.outcome == 'success' && 'success' || 'failure' }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          COLOR=$([ "$STATUS" = "success" ] && echo 3066993 || echo 15158332)
          ICON=$([ "$STATUS" = "success" ] && echo "âœ…" || echo "âŒ")
          DESCRIPTION=$([ "$STATUS" = "success" ] && echo "ğŸ“Š **System Status: Healthy**" || echo "âŒ **System Status: Issues Detected**")

          JSON_PAYLOAD=$(jq -n \
            --arg status "$STATUS" \
            --arg icon "$ICON" \
            --arg description "$DESCRIPTION" \
            --arg color "$COLOR" \
            ' {
                embeds: [{
                  title: "ğŸ“Š SYSTEM STATUS CHECK",
                  description: $description,
                  color: ($color | tonumber),
                  fields: [
                    { name: "ğŸ“Š Tráº¡ng thÃ¡i", value: "\($icon) \($status | ascii_upcase)", inline: true },
                    { name: "â° Thá»i gian", value: "\(now | strftime("%Y-%m-%d %H:%M:%S UTC"))", inline: true }
                  ],
                  footer: { "text": "ğŸ“Š System Status Check" },
                  timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
                }]
              }')

          curl -s -H "Content-Type: application/json" -X POST -d "$JSON_PAYLOAD" "$DISCORD_WEBHOOK" || echo "Lá»—i gá»­i thÃ´ng bÃ¡o Discord"
