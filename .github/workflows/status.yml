name: üìä System Status Check

on:
  schedule:
    - cron: '0 */6 * * *' # Ch·∫°y m·ªói 6 gi·ªù
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Lo·∫°i ki·ªÉm tra'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - services
          - database
          - monitoring

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
  VPS_PATH: ${{ secrets.VPS_PATH }}

jobs:
  status-check:
    name: üìä Check System Status
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîç Check Docker Swarm Status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail
            cd "${{ env.VPS_PATH }}"

            echo "üîç Checking Docker Swarm status..."

            # Check stack status
            if docker stack ls | grep -q "shopsifu"; then
              echo "‚úÖ Stack 'shopsifu' exists"
              docker service ls
            else
              echo "‚ùå Stack 'shopsifu' not found"
              exit 1
            fi

            # Check service health
            echo "üè• Checking service health..."
            docker service ls --format "table {{.Name}}\t{{.Replicas}}\t{{.Image}}\t{{.Ports}}"

      - name: üóÑÔ∏è Check Database Status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "üóÑÔ∏è Checking database status..."

            # Check PostgreSQL
            if pg_isready -h localhost -p 5432 -U shopsifu; then
              echo "‚úÖ PostgreSQL is ready"
            else
              echo "‚ùå PostgreSQL is not ready"
            fi

            # Check Redis
            if redis-cli -a "Shopsifu2025" ping | grep -q "PONG"; then
              echo "‚úÖ Redis is ready"
            else
              echo "‚ùå Redis is not ready"
            fi

            # Check Elasticsearch
            if curl -fsS http://localhost:9200 > /dev/null; then
              echo "‚úÖ Elasticsearch is ready"
            else
              echo "‚ùå Elasticsearch is not ready"
            fi

      - name: üìä Check Monitoring Status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "üìä Checking monitoring status..."

            # Check Prometheus
            if curl -fsS http://localhost:9090/-/healthy > /dev/null; then
              echo "‚úÖ Prometheus is healthy"
            else
              echo "‚ùå Prometheus is not healthy"
            fi

            # Check Grafana
            if curl -fsS http://localhost:3001/api/health > /dev/null; then
              echo "‚úÖ Grafana is healthy"
            else
              echo "‚ùå Grafana is not healthy"
            fi

            # Check Kibana
            if curl -fsS http://localhost:5601/api/status > /dev/null; then
              echo "‚úÖ Kibana is healthy"
            else
              echo "‚ùå Kibana is not healthy"
            fi

      - name: üöÄ Check Application Status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "üöÄ Checking application status..."

            # Check server health
            if curl -fsS http://localhost:3000/health > /dev/null; then
              echo "‚úÖ Application server is healthy"
            else
              echo "‚ùå Application server is not healthy"
            fi

            # Check server metrics
            echo "üìà Server metrics:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}"

  notification:
    name: üì¢ Status Notification
    needs: status-check
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: always()
    steps:
      - name: üì¢ Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ needs.status-check.outcome == 'success' && 'success' || 'failure' }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          COLOR=$([ "$STATUS" = "success" ] && echo 3066993 || echo 15158332)
          ICON=$([ "$STATUS" = "success" ] && echo "‚úÖ" || echo "‚ùå")
          DESCRIPTION=$([ "$STATUS" = "success" ] && echo "üìä **System Status: Healthy**" || echo "‚ùå **System Status: Issues Detected**")

          JSON_PAYLOAD=$(jq -n \
            --arg status "$STATUS" \
            --arg icon "$ICON" \
            --arg description "$DESCRIPTION" \
            --arg color "$COLOR" \
            ' {
                embeds: [{
                  title: "üìä SYSTEM STATUS CHECK",
                  description: $description,
                  color: ($color | tonumber),
                  fields: [
                    { name: "üìä Tr·∫°ng th√°i", value: "\($icon) \($status | ascii_upcase)", inline: true },
                    { name: "‚è∞ Th·ªùi gian", value: "\(now | strftime("%Y-%m-%d %H:%M:%S UTC"))", inline: true }
                  ],
                  footer: { "text": "üìä System Status Check" },
                  timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
                }]
              }')

          curl -s -H "Content-Type: application/json" -X POST -d "$JSON_PAYLOAD" "$DISCORD_WEBHOOK" || echo "L·ªói g·ª≠i th√¥ng b√°o Discord"
