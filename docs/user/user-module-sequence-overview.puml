@startuml
!theme aws-orange
skinparam backgroundColor #FFFFFF
skinparam defaultTextAlignment center
skinparam participant {
    BackgroundColor #E8F4FD
    BorderColor #1976D2
    FontColor #000000
    FontStyle bold
}
skinparam actor {
    BackgroundColor #FFF8E1
    BorderColor #F57C00
    FontColor #000000
    FontStyle bold
}
skinparam database {
    BackgroundColor #F3E5F5
    BorderColor #7B1FA2
    FontColor #000000
    FontStyle bold
}
skinparam note {
    BackgroundColor #FFFDE7
    BorderColor #F9A825
    FontColor #000000
}

title Mô-đun Người Dùng - Tổng Quan Luồng Xử Lý
note top : Hệ thống quản lý người dùng với phân quyền và xử lý lỗi toàn diện

actor "Người dùng" as Client
participant "UserController" as UC
participant "UserService" as US
participant "UserRepo" as UR
participant "SharedUserRepo" as SUR
participant "HashingService" as HS
participant "SharedRoleRepo" as SRR
participant "I18nService" as IS
participant "PrismaService" as PS
database "PostgreSQL" as DB

== Luồng Xử Lý Chính ==
Client -> UC: Yêu cầu (GET/POST/PUT/DELETE)
UC -> US: Xử lý nghiệp vụ + Validation

alt Thao tác CRUD cơ bản
    US -> US: Mã hóa mật khẩu (HashingService)
    US -> UR: Thực hiện CRUD
    UR -> PS: SELECT COUNT(*) + Query với LIMIT/OFFSET
    PS -> DB: Thực thi query với pagination
    DB -> PS: Dữ liệu + Thống kê phân trang
    PS -> UR: Kết quả có metadata (total, hasNext, hasPrev)
    UR -> US: Trả về data với metadata

else Lấy thông tin chi tiết User
    US -> SUR: findUniqueIncludeRolePermissions
    SUR -> PS: JOIN với Role + Permissions
    PS -> DB: Query user với role permissions
    DB -> PS: User profile đầy đủ
    PS -> SUR: Thông tin user + quyền hạn
    SUR -> US: Trả về user detail
end

== Kiểm Tra Phân Quyền ==
alt Admin thực hiện thao tác đặc biệt
    US -> US: verifyRole(người thực hiện, đối tượng)
    note right
    Logic nghiệp vụ phân quyền:
    • Chỉ Admin tạo/sửa/xóa Admin khác
    • Ngăn chặn tự thao tác trên chính mình
    • Validation Role ID hợp lệ
    end note

else Không đủ quyền hoặc vi phạm quy tắc
    US -> UC: Exception tương ứng
    UC -> Client: HTTP Error Response
end

== Xử Lý Ngoại Lệ ==
alt Các trường hợp lỗi phổ biến
    US -> UC: Exception
    UC -> Client: Error Response
    note right
    **Ma trận xử lý lỗi:**
    • 404 Not Found → User không tồn tại
    • 422 Unprocessable → Email trùng / Role ID sai
    • 403 Forbidden → Không đủ quyền / Tự thao tác
    • 500 Internal → Lỗi hệ thống / Database
    end note
end

== Trả Kết Quả ==
US -> IS: i18n.t('user.user.success.XXX')
IS -> US: Trả về message đã localize
US -> UC: Phản hồi + Message đã localize
UC -> Client: JSON Response với metadata đầy đủ

note bottom
**Đặc điểm chính của module User:**
• Phân quyền nghiêm ngặt (Admin/Seller/User)
• Mã hóa mật khẩu với HashingService
• Soft delete với audit fields
• Validation unique constraint (email)
• Foreign key validation (roleId)
• Ngăn chặn tự thao tác trên chính mình
• Đa ngôn ngữ với I18nService
• Pagination với metadata
end note

@enduml
