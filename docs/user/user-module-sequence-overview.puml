@startuml
!theme aws-orange
skinparam backgroundColor #FFFFFF
skinparam defaultTextAlignment center
skinparam participant {
    BackgroundColor #E8F4FD
    BorderColor #1976D2
    FontColor #000000
    FontStyle bold
}
skinparam actor {
    BackgroundColor #FFF8E1
    BorderColor #F57C00
    FontColor #000000
    FontStyle bold
}
skinparam database {
    BackgroundColor #F3E5F5
    BorderColor #7B1FA2
    FontColor #000000
    FontStyle bold
}
skinparam note {
    BackgroundColor #FFFDE7
    BorderColor #F9A825
    FontColor #000000
}

title Mô-đun User - Tổng Quan Sequence
note top : Hệ thống quản lý người dùng với phân quyền và xử lý lỗi toàn diện

actor "Người dùng" as Client
participant UserController
participant UserService
participant UserRepo
participant SharedUserRepo
database PostgreSQL

== Luồng Xử Lý Chính ==
Client -> UserController: Yêu cầu (GET/POST/PUT/DELETE)
UserController -> UserService: Xử lý nghiệp vụ + Validation

alt Thao tác CRUD cơ bản
    UserService -> UserService: Mã hóa mật khẩu (HashingService)
    UserService -> UserRepo: Thực hiện CRUD
    UserRepo -> PostgreSQL: SELECT COUNT(*) + Query với LIMIT/OFFSET
    PostgreSQL --> UserRepo: Dữ liệu + Thống kê phân trang
    UserRepo --> UserService: Kết quả có metadata (total, hasNext, hasPrev)

else Lấy thông tin chi tiết User
    UserService -> SharedUserRepo: findUniqueIncludeRolePermissions
    SharedUserRepo -> PostgreSQL: JOIN với Role + Permissions
    PostgreSQL --> SharedUserRepo: User profile đầy đủ
    SharedUserRepo --> UserService: Thông tin user + quyền hạn
end

== Kiểm Tra Phân Quyền ==
alt Admin thực hiện thao tác đặc biệt
    UserService -> UserService: verifyRole(người thực hiện, đối tượng)
    note right
    Logic nghiệp vụ phân quyền:
    • Chỉ Admin tạo/sửa/xóa Admin khác
    • Ngăn chặn tự thao tác trên chính mình
    • Validation Role ID hợp lệ
    end note

else Không đủ quyền hoặc vi phạm quy tắc
    UserService --> UserController: Exception tương ứng
    UserController --> Client: HTTP Error Response
end

== Xử Lý Ngoại Lệ ==
alt Các trường hợp lỗi phổ biến
    UserService --> UserController: Exception
    UserController --> Client: Error Response
    note right
    **Ma trận xử lý lỗi:**
    • 404 Not Found → User không tồn tại
    • 422 Unprocessable → Email trùng / Role ID sai
    • 403 Forbidden → Không đủ quyền / Tự thao tác
    • 500 Internal → Lỗi hệ thống / Database
    end note
end

== Trả Kết Quả ==
UserService -> UserService: Tạo thông báo đa ngôn ngữ (I18nService)
UserService --> UserController: Response + Message đã localize
UserController --> Client: JSON Response với metadata đầy đủ

@enduml
